/*********************************************************************************************\
*               Edmund's Audio Synchronization Suite - Audio keyframes smoother
*                           Programmed by Héctor Colás Valtueña @2019
*                                           ====================
*               Smooths off the audio keyframes generated by Adobe's built-in
*               "Keyframe assistant > Convert audio to keyframes" into a new null layer
*
\*********************************************************************************************/

//dialog defaults
    var defSmoothRate = 0.99;
    var defSrcLayer = "Audio Amplitude";
    var defTarLayer = "Audio Smoothie";
    
    var defTarProperty = "Both Channels";


//Window setup
    var mainWindow = new Window("dialog", "EASS Audio Keyframes Smoother"); //("palette")
    mainWindow.add("statictext", undefined, "Input parameters and press 'magic' for hitler");
    //smoothing rate input
    winGrpTmp = mainWindow.add("group");
    winGrpTmp.orientation = "row";
    winGrpTmp.add("statictext", undefined,  "Smooth rate (0.0 - 1.0)");
    var inputSmoothRate = winGrpTmp.add("edittext", [0, 0, 150, 35], defSmoothRate);
    //source Layer Input group
    winGrpTmp = mainWindow.add("group");
    winGrpTmp.orientation = "row";
    winGrpTmp.add("statictext", undefined,  "Input layer name");
    var inputSrcLayer = winGrpTmp.add("edittext", [0, 0, 200, 35], defSrcLayer);
    //target Layer Input group
    winGrpTmp = mainWindow.add("group");
    winGrpTmp.orientation = "row";
    winGrpTmp.add("statictext", undefined,  "New layer name");
    var inputTarLayerName = winGrpTmp.add("edittext", [0, 0, 200, 35], defTarLayer);
    
    //launch button
    winGrpTmp = mainWindow.add("group");
    winGrpTmp.add("button", undefined, "MAGIC").onClick = JUSTDOIT;

    //var progressTextfield = mainWindow.add("statictext", undefined, "");

    mainWindow.show();
    //mainWindow.center();
//Endof Window setup


function JUSTDOIT () {
//constants and definitions
    var mainComp = app.project.activeItem;

//input initialization and validity check
    var smoothRate = parseFloat(inputSmoothRate.text);
    var tarLayerName = inputTarLayerName.text;
    if (mainComp === null || mainComp === undefined) { $.writeln("!!Couldn't find target composition, aborted."); alert("Couldn't find target composition, aborted."); return; }
    var srcLayer = mainComp.layer(inputSrcLayer.text);

    if (isNaN(smoothRate)) { $.writeln("Wrong smooth rate input: ", threshold); alert("Invalid smooth rate input"); return; }
    if (tarLayerName == "") { $.writeln("Must input non-empty string for target layer name"); alert("Must input non-empty string for target layer name"); return; }
    if (srcLayer === null) { $.writeln("Wrong source layer input - not found: ", inputSrcLayer.text); alert("Invalid source layer input - not found"); return; }

//deploy progress indicator dialog

//echo input to console
    $.writeln("================");
    $.writeln("input values:\r  smoothRate: ", smoothRate, "\r  tarLayerName: ", tarLayerName, "\n  srcLayer:", srcLayer);
    $.writeln("  srcLayer name: \"", srcLayer.name, "\"");
    $.writeln("  tarLayerName: \"", tarLayerName, "\"");

//Process initialization
    app.beginUndoGroup("MAGIC");
    
    //Create and set up a new destination layer and property
    var tarLayer = mainComp.layers.addNull();
        tarLayer.name = tarLayerName;
        tarLayer.inPoint = srcLayer.inPoint;
        tarLayer.outPoint = srcLayer.outPoint;
    var tarProp = tarLayer.effect.addProperty("Slider Control").slider;    //<<====
    
    //gather a reference to the source property and validate
    var srcProp = srcLayer.effect("Both Channels").slider;  //<<====
        $.writeln("  Source Property  # keys: ", srcProp.numKeys);
    if (srcProp.numKeys <= 0) { $.writeln("!!Source property has no keyframes!"); alert("Error: Source property has no keyframes!"); return; }
    
    //Setup initial keyframe and data before main loop
    var prevValue = srcProp.keyValue(1);
    $.writeln(tarProp);
    tarProp.setValueAtTime(srcProp.keyTime(1), prevValue);
    
//Main loop
    var numKeys = srcProp.numKeys;
    var smoothedValue, newValue;
    for (var keyIndex = 2; keyIndex <= numKeys; keyIndex++) {
        //calculate a minimum value for the current frame from a fraction of previous frame's value
        smoothedValue = prevValue * smoothRate;    //<<====
        
        //Create a new key with the largest value out of the smoothed curve or sample
        prevValue = largest(smoothedValue, srcProp.keyValue(keyIndex))
        tarProp.setValueAtTime(srcProp.keyTime(keyIndex), prevValue);
        
        //update the progress dialog
        $.writeln("  Processed key #", keyIndex);
        //updateProgressText(keyIndex, numKeys);
    }

//finishing clean-up
    app.endUndoGroup();
 
    alert("ALAKHAZAM!\r(done)");
 
 
 //support function definitions
    //returns the biggest number of the two
    function largest (firstVal, secondVal) {
        return (firstVal > secondVal) ? firstVal : secondVal;
    } 

    /*//updates the displayed progress dialog with current progress
    function updateProgressText (curKey, maxKeys) {
        if(progressTextfield === null || progressTextfield === undefined) { return; }
        progressTextfield.text = ("" + curKey + " / " + maxKeys);
        mainWindow.update();
    }*/
}
